<!DOCTYPE html>
<!-- xlsx.js (C) 2013-present  SheetJS http://sheetjs.com -->
<!-- vim: set ts=2: -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>SheetJS Live Demo</title>
<style>
#drop{
	border:2px dashed #bbb;
	-moz-border-radius:5px;
	-webkit-border-radius:5px;
	border-radius:5px;
	padding:25px;
	text-align:center;
	font:20pt bold,"Vollkorn";color:#bbb
}
#b64data{
	width:100%;
}
a { text-decoration: none }
</style>
</head>
<body>
<pre><b><a href="http://sheetjs.com">SheetJS Data Preview Live Demo</a></b>
(Base64 text works back to IE6; drag and drop works back to IE10)

</br>
<div id="drop">Drop a spreadsheet file here to see sheet data</div>
<input type="file" name="xlfile" id="xlf" /> ... or click here to select a file

<textarea id="b64data">... or paste a base64-encoding here</textarea>
<input type="button" id="dotext" value="Click here to process the base64 text" onclick="b64it();"/><br />
<b>Advanced Demo Options:</b>
Use Web Workers: (when available) <input type="checkbox" name="useworker" checked>
Use readAsBinaryString: (when available) <input type="checkbox" name="userabs" checked>
</pre>
<pre id="out"></pre>
<div id="htmlout"></div>
<br />
<script src="shim.js"></script>
<script src="xlsx.full.min.js"></script>
<script>
/*jshint browser:true */
/* eslint-env browser */
/* eslint no-use-before-define:0 */
/*global Uint8Array, Uint16Array, ArrayBuffer */
/*global XLSX */
var X = XLSX;
var XW = {
	/* worker message */
	msg: 'xlsx',
	/* worker scripts */
	worker: './xlsxworker.js'
};

var global_wb;

var process_wb = (function() {
	var OUT = document.getElementById('out');
	var HTMLOUT = document.getElementById('htmlout');

	var to_json = function to_json(workbook) {
		var result = {};
		workbook.SheetNames.forEach(function(sheetName) {
			var roa = X.utils.sheet_to_json(workbook.Sheets[sheetName]);
			if(roa.length) result[sheetName] = roa;
		});
		return JSON.stringify(result, 2, 2);
	};

	var to_xlsx = function to_xlsx(workbook) {
		HTMLOUT.innerHTML = "";
		XLSX.writeFile(workbook, "SheetJSTest.xlsx");
		return "";
	};
  
    const OutputSheetName = '收支明细';
    function arrangeByBorrow(wb) {
      const ID = "编号", Time = "时间", RevNum = "收入金额", Desc = "明细", RevName = "收款人", Agent = "经手人", Note = "备注";
      const HeaderTitles = {ID, Time, RevNum, Desc, RevName, Agent, Note};
      var sheets = Object.values(wb.Sheets);
      var records = [];
      sheet: for(let sheetName of wb.SheetNames) {
        if(sheetName == OutputSheetName) continue;
        let sheet = wb.Sheets[sheetName];
        let range = X.utils.decode_range(sheet['!ref']);
        let header = Array(range.e.c+1).fill(0).map((_,i)=>sheet[X.utils.encode_cell({r:0, c:i})]).filter(e=>e!=null).map(e=>e.v);
        for(let key in HeaderTitles ) {
            let title = HeaderTitles[key];
            let i = header.findIndex(e=> new RegExp(title).test(e));
            if(i == -1)  {
                alert(`由于没有找到表头行，表《${sheetName}》被跳过\n`+ '表头行(包含"编号，时间，收入金额，明细，收款人，经手人，备注"字段)必须在工作表的第一行');
                continue sheet;
            }
            header[i] = key;
            sheet[X.utils.encode_cell({r:0, c:i})].w = key;
            sheet[X.utils.encode_cell({r:0, c:i})].v = key;
        }
        let jsonData = X.utils.sheet_to_json(sheet, {header});
        spawnSheetsByJson(jsonData);
      }
    }

function spawnSheetsByJson(json){
  let spreadSheet = X.utils.book_new();
  let cols = 0, rols = 0;

  function appendRow(arr) {
      for(let c=0; c<arr.length; c++) {
          let addr = {c, r: rols};
          if(typeof arr[c] == 'object') {
              sheet[addr] = arr[c];
          } else {
              sheet[addr] = {v: arr[c]};
          }
      }
      rols++;
  }

  appendRow(["借款人", "时间",	"金额",	"事由",	"经手人",	"备注"]);
  
  for(let {RevName: name, Time: time, RevNum: num, Agent: agent, Note: note} of json) {
      appendRow([
          name, {t:"d", v:time}, num, "", agent, note
      ]);
  }

  return to_json(sheet);
}

function parseDate(date) {
  if(Object.prototype.toString.call(date) == '[object Date]') {
    return date;
  }
  if(Object.prototype.toString.call(date) == '[object String]') {
    let fmt1 = date.match(/^(\d+)\.(\d+)\.(\d+)$/);
    let fmt2 = date.match(/^(\d+)-(\d+)-(\d+)$/);
    let fmt = fmt1 == null ? fmt2 : fmt1;
    if(fmt != null ) {
      let object = null;
      try {
         object = new Date(+fmt[1], fmt[2]-1, +fmt[3]);
      } catch(err){
         object = new Date(1970, 0, 1);
      }
      return object;
    }
    return 'Invalid Date String.';
  }
}

	return function process_wb(wb) {
		global_wb = wb;
		var output = "";

    output = arrangeByBorrow(wb);
		if(OUT.innerText === undefined) OUT.textContent = output;
		else OUT.innerText = output;
		if(typeof console !== 'undefined') console.log("output", new Date());
	};
})();

var b64it = window.b64it = (function() {
	var tarea = document.getElementById('b64data');
	return function b64it() {
		if(typeof console !== 'undefined') console.log("onload", new Date());
		var wb = X.read(tarea.value, {type:'base64', WTF:false});
		process_wb(wb);
	};
})();

var do_file = (function() {
	var rABS = typeof FileReader !== "undefined" && (FileReader.prototype||{}).readAsBinaryString;
	var domrabs = document.getElementsByName("userabs")[0];
	if(!rABS) domrabs.disabled = !(domrabs.checked = false);

	var use_worker = typeof Worker !== 'undefined' && false;
	var domwork = document.getElementsByName("useworker")[0];
	if(!use_worker) domwork.disabled = !(domwork.checked = false);

	var xw = function xw(data, cb) {
		var worker = new Worker(XW.worker);
		worker.onmessage = function(e) {
			switch(e.data.t) {
				case 'ready': break;
				case 'e': console.error(e.data.d); break;
				case XW.msg: cb(JSON.parse(e.data.d)); break;
			}
		};
		worker.postMessage({d:data,b:rABS?'binary':'array'});
	};

	return function do_file(files) {
		rABS = domrabs.checked;
		use_worker = domwork.checked;
		var f = files[0];
		var reader = new FileReader();
		reader.onload = function(e) {
			if(typeof console !== 'undefined') console.log("onload", new Date(), rABS, use_worker);
			var data = e.target.result;
			if(!rABS) data = new Uint8Array(data);
			if(use_worker) xw(data, process_wb);
			else process_wb(X.read(data, {type: rABS ? 'binary' : 'array'}));
		};
		if(rABS) reader.readAsBinaryString(f);
		else reader.readAsArrayBuffer(f);
	};
})();

(function() {
	var drop = document.getElementById('drop');
	if(!drop.addEventListener) return;

	function handleDrop(e) {
		e.stopPropagation();
		e.preventDefault();
		do_file(e.dataTransfer.files);
	}

	function handleDragover(e) {
		e.stopPropagation();
		e.preventDefault();
		e.dataTransfer.dropEffect = 'copy';
	}

	drop.addEventListener('dragenter', handleDragover, false);
	drop.addEventListener('dragover', handleDragover, false);
	drop.addEventListener('drop', handleDrop, false);
})();

(function() {
	var xlf = document.getElementById('xlf');
	if(!xlf.addEventListener) return;
	function handleFile(e) { do_file(e.target.files); }
	xlf.addEventListener('change', handleFile, false);
})();

</script>
</body>
</html>
