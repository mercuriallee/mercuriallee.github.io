<div class="highlight"><pre><span class="k">function</span> <span class="nf">encrypt_file</span><span class="p">(</span><span class="nv">$file_location</span><span class="p">,</span><span class="nv">$destination</span><span class="p">){</span>

    <span class="nv">$source_file</span><span class="o">=</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$file_location</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">);</span>
    <span class="nv">$destination_file</span><span class="o">=</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$destination</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>

    <span class="nv">$key</span><span class="o">=</span><span class="nx">createSecret</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>  <span class="c1">//triple DES是24字节密钥,DES是8字节,密钥是16进制数构成</span>
    <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;des_key&#39;</span><span class="p">]</span><span class="o">=</span><span class="nv">$key</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$source_file</span><span class="p">)){</span>
        <span class="nv">$package</span><span class="o">=</span><span class="nb">fread</span><span class="p">(</span><span class="nv">$source_file</span><span class="p">,</span><span class="mi">1152</span><span class="p">);</span>

        <span class="nv">$package</span><span class="o">=</span><span class="nx">self</span><span class="o">::</span><span class="na">encrypt</span><span class="p">(</span><span class="nv">$package</span><span class="p">,</span><span class="nv">$key</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">fwrite</span><span class="p">(</span><span class="nv">$destination_file</span><span class="p">,</span><span class="nv">$package</span><span class="p">)){</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$source_file</span><span class="p">);</span>
    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$destination</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">function</span> <span class="nf">encrypt</span><span class="p">(</span><span class="nv">$encrypt</span><span class="p">,</span><span class="nv">$key</span><span class="p">){</span>

    <span class="nv">$encrypt</span><span class="o">=</span><span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$encrypt</span><span class="p">);</span>

    <span class="nv">$iv</span> <span class="o">=</span> <span class="nb">mcrypt_create_iv</span><span class="p">(</span><span class="nb">mcrypt_get_iv_size</span><span class="p">(</span><span class="nx">MCRYPT_3DES</span><span class="p">,</span><span class="nx">MCRYPT_MODE_ECB</span><span class="p">),</span><span class="nx">MCRYPT_RAND</span><span class="p">);</span>
    <span class="nv">$passcrypt</span> <span class="o">=</span> <span class="nb">mcrypt_encrypt</span><span class="p">(</span><span class="nx">MCRYPT_3DES</span> <span class="p">,</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$encrypt</span><span class="p">,</span> <span class="nx">MCRYPT_MODE_ECB</span><span class="p">,</span> <span class="nv">$iv</span><span class="p">);</span>

    <span class="nv">$encode</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$passcrypt</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$encode</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">function</span> <span class="nf">createSecret</span><span class="p">(</span><span class="nv">$secretLength</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$validChars</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;=&#39;</span>  
    <span class="p">);</span>

    <span class="nb">unset</span><span class="p">(</span><span class="nv">$validChars</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>

    <span class="nv">$secret</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$secretLength</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$secret</span> <span class="o">.=</span> <span class="nv">$validChars</span><span class="p">[</span><span class="nb">array_rand</span><span class="p">(</span><span class="nv">$validChars</span><span class="p">)];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$secret</span><span class="p">;</span>
<span class="p">}</span>
    

<span class="k">function</span> <span class="nf">decrypt_file</span><span class="p">(</span><span class="nv">$file_location</span><span class="p">,</span><span class="nv">$key</span><span class="p">){</span>

    <span class="nv">$tmp_file_location</span><span class="o">=</span><span class="s1">&#39;/tmp/&#39;</span><span class="o">.</span><span class="nb">base64_encode</span><span class="p">(</span><span class="nx">create_uuid</span><span class="p">());</span>

    <span class="nv">$tmp_file</span><span class="o">=</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$tmp_file_location</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>
    <span class="nv">$source_file</span><span class="o">=</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$file_location</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">);</span>

    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$source_file</span><span class="p">)){</span>
        <span class="nv">$package</span><span class="o">=</span><span class="nb">fread</span><span class="p">(</span><span class="nv">$source_file</span><span class="p">,</span><span class="mi">2048</span><span class="p">);</span>

        <span class="nv">$package_decrypted</span><span class="o">=</span><span class="nx">decrypt</span><span class="p">(</span><span class="nv">$package</span><span class="p">,</span><span class="nv">$key</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">fwrite</span><span class="p">(</span><span class="nv">$tmp_file</span><span class="p">,</span><span class="nv">$package_decrypted</span><span class="p">)){</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$tmp_file</span><span class="p">);</span>
    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$source_file</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$tmp_file_location</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">function</span> <span class="nf">decrypt</span><span class="p">(</span><span class="nv">$decrypt</span><span class="p">,</span><span class="nv">$key</span><span class="p">){</span>  

    <span class="nv">$decoded</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$decrypt</span><span class="p">);</span>

    <span class="nv">$iv</span> <span class="o">=</span> <span class="nb">mcrypt_create_iv</span><span class="p">(</span><span class="nb">mcrypt_get_iv_size</span><span class="p">(</span><span class="nx">MCRYPT_3DES</span><span class="p">,</span><span class="nx">MCRYPT_MODE_ECB</span><span class="p">),</span><span class="nx">MCRYPT_RAND</span><span class="p">);</span>
    <span class="nv">$decrypted</span> <span class="o">=</span> <span class="nb">mcrypt_decrypt</span><span class="p">(</span><span class="nx">MCRYPT_3DES</span> <span class="p">,</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$decoded</span><span class="p">,</span> <span class="nx">MCRYPT_MODE_ECB</span><span class="p">,</span> <span class="nv">$iv</span><span class="p">);</span>

    <span class="nv">$decrypted</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$decrypted</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$decrypted</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>